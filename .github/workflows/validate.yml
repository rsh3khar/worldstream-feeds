name: Validate Feeds

on:
  pull_request:
    paths:
      - 'feeds.yaml'
  push:
    branches:
      - main
    paths:
      - 'feeds.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Validate feeds.yaml
        run: |
          python scripts/validate_feeds.py feeds.yaml

      - name: Check file size
        run: |
          size=$(stat -f%z feeds.yaml 2>/dev/null || stat -c%s feeds.yaml)
          if [ $size -gt 5000000 ]; then
            echo "❌ feeds.yaml is too large: $size bytes (max 5MB)"
            exit 1
          fi
          echo "✅ File size OK: $size bytes"

      - name: Security check - No secrets
        run: |
          # Check for potential API keys/secrets
          if grep -iE '(api[_-]?key|secret|password|token)' feeds.yaml; then
            echo "❌ Potential secrets detected in feeds.yaml"
            exit 1
          fi
          echo "✅ No secrets detected"

      - name: Validation summary
        if: success()
        run: |
          echo "✅ All validations passed!"
          echo "PR is ready for manual review."
